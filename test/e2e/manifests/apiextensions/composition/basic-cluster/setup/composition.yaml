apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: basic-composition-cluster
spec:
  compositeTypeRef:
    apiVersion: example.org/v1alpha1
    kind: ClusterTest
  mode: Pipeline
  pipeline:
  - step: validate-and-compose
    functionRef:
      name: function-python-ext-basic
    input:
      apiVersion: python.fn.crossplane.io/v1beta1
      kind: Script
      script: |
        from crossplane.function import request, response
        from crossplane.function.proto.v1 import run_function_pb2 as fnv1

        def compose(req: fnv1.RunFunctionRequest, rsp: fnv1.RunFunctionResponse):
            observed_xr = req.observed.composite.resource

            observed_composite_received = "spec" in observed_xr
            observed_composite_has_cool_field = False
            if observed_composite_received and "coolField" in observed_xr["spec"]:
                observed_composite_has_cool_field = observed_xr["spec"]["coolField"] == "I'm cool!"

            credentials_received = "important-secret" in req.credentials

            observed_composed_resources_received = len(req.observed.resources) > 0

            rsp.desired.composite.resource.update({
                "status": {
                    "coolerField": "I'M COOLER!",
                    "observedCompositeReceived": observed_composite_received,
                    "observedCompositeHasCoolField": observed_composite_has_cool_field,
                    "credentialsReceived": credentials_received,
                    "observedComposedResourcesReceived": observed_composed_resources_received,
                }
            })

            rsp.desired.resources["configmap"].resource.update({
                "apiVersion": "v1",
                "kind": "ConfigMap",
                "metadata": {
                    "namespace": "default",
                },
                "data": {
                    "coolData": "I'm cool!",
                }
            })
            rsp.desired.resources["configmap"].ready = fnv1.READY_TRUE

            rsp.desired.resources["crd"].resource.update({
                "apiVersion": "apiextensions.k8s.io/v1",
                "kind": "CustomResourceDefinition",
                "metadata": {
                    "name": "controllers.test.example.org",
                },
                "spec": {
                    "group": "test.example.org",
                    "names": {
                        "kind": "Controller",
                        "plural": "controllers",
                    },
                    "scope": "Cluster",
                    "versions": [{
                        "name": "v1alpha1",
                        "served": True,
                        "storage": True,
                        "schema": {
                            "openAPIV3Schema": {
                                "type": "object",
                            },
                        },
                    }],
                },
            })
            rsp.desired.resources["crd"].ready = fnv1.READY_TRUE

            response.normal(rsp, "I am doing a compose!")
    credentials:
    - name: important-secret
      source: Secret
      secretRef:
        namespace: crossplane-system
        name: super-secret
